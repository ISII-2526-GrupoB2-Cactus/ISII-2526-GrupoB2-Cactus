@page "/rental/SelectDevicesForRental"


@using AppForSEII2526.Web.API
@using AppForSEII2526.Web.Components.Shared
@using Microsoft.AspNetCore.Authorization


@inject ILogger<SelectDevicesForRental> logger
@inject CactusAPIClient apiclient
@inject RentalStateContainer rentalState
@inject NavigationManager navigation



@attribute [Authorize]
<h3>Seleccionar dispositivos</h3>

<div class="container-fluid">
    <div class="row alert alert-danger" role="alert" hidden="@hideErrors">
        <p id="ErrorsShown">Errors: @errors</p>
    </div>
    <div class="row">
        <div class="col-8">
            <div class="row">
                <div class="col">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">Model</span>
                        <input type="text" id="inputModel" @bind="deviceModel" class="form-control" placeholder="Model" aria-label="Model" aria-describedby="basic-addon1">
                    </div>
                </div>
                <div class="col">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">Price</span>
                        
                        <select class="form-select" aria-label="Default select" @bind="deviceModelSelected" id="selectModel">
                            <option value="All" selected>All</option>
                            @foreach (string modelName in modelsNames)
                            {
                                <option value="@modelName" id="modelNameSelected_@modelName">@modelName</option>
                            }
                        </select>

                    </div>
                </div>
                <div class="col">
                    <div class="input-group mb-3">
                        <span class="input-group-text">From</span>
                        <InputDate @bind-Value="From" id="fromDate" />
                    </div>
                </div>
                <div class="col">
                    <div class="input-group mb-3">
                        <span class="input-group-text">To</span>
                        <InputDate id="toDate" @bind-Value="To" />
                    </div>
                </div>
                <div class="col">
                    <button type="button" class="btn btn-primary" @onclick="SearchDevices" id="searchDevices">Search devices</button>
                </div>
            </div>
            <div class="row">
                @if (devices == null)
                {
                    <p>Loading devices....</p>
                }
                else
                {
                    <div class="mh-100 table-responsive">
                        <table class="table table-condensed table-hover" id="TableOfDevices">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Brand</th>
                                    <th>Model</th>
                                    <th>Price For Rent</th>
                                    <th>Rent</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var device in devices)
                                {
                                    <tr id="DeviceData_@device.Id">
                                        <td>@device.Name</td>
                                        <td>@device.Brand</td>
                                        <td>@device.Model</td>
                                        <td>@device.PriceForRent</td>
                                        <td>
                                            <button class="btn btn-outline-secondary" id="deviceToRent_@device.Id" @onclick="@(() => AddDevice(device))">Add</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
        <div class="col-2" hidden="@hideRentingCart">
            <div class="row">
                <h3>Shopping Cart</h3>
            </div>
            @foreach (RentalItemDTO item in rental.RentalItems)
            {
                <div class="row">
                    <button type="button" class="btn btn-light" id="removeDevice_@item.Model" @onclick="@(() => RemoveRentalItem(item))">x @item.Model - @item.PriceForRent€</button>
                </div>
            }
            <div class="row">
                <button type="button" class="btn btn-primary" id="purchaseDeviceButton" @onclick=@RentDevices>Rent devices</button>
            </div>


        </div>
    </div>
</div>







@code {
    private string deviceModelSelected;
    private ICollection<string>? modelsNames = new List<string>();
    private bool hideRentingCart { get { return rental.RentalItems.Count == 0; } }
    private ICollection<DeviceParaAlquilarDTO>? devices;
    private bool hideErrors { get { return errors.Length == 0; } }
    private string errors = "";
    private string? deviceModel { get; set; }
    private double? priceForRent { get; set; }
    private DateTime _from;
    private DateTime From
    {
        get { return _from; }
        set
        {
            if (_from != value)
            {
                //the rentingcart is cleared to ensure that only devices available for the selected period are selected
                _from = value;
                rental.RentalDateFrom = DateTime.SpecifyKind(_from, DateTimeKind.Utc);
                rentalState.ClearRentingCart();
            }
        }
    }

    private DateTime _to;
    private DateTime To{
        get { return _to; }
        set{
            if (_to != value)
            {
                //the rentingcart is cleared to ensure that only devices available for the selected period are selected
                _to = value;
                rental.RentalDateTo = DateTime.SpecifyKind(_to, DateTimeKind.Utc);
                rentalState.ClearRentingCart();
            }
        }
    }

    private RentalForCreateDTO rental => rentalState.Rental;

    private bool hiddenRentingCart = true;

    private void AddDevice(DeviceParaAlquilarDTO device)
    {
        rentalState.AddDeviceToRental(device);
    }

    private void RemoveRentalItem(RentalItemDTO item)
    {
        rentalState.RemoveRentalItemToRent(item);
        if (rental.RentalItems.Count == 0) hiddenRentingCart = true;
    }

    public async void SearchDevices()
    {

        deviceModel = deviceModelSelected == "All" ? null : deviceModelSelected;

        if (rental.RentalDateFrom > rental.RentalDateTo)
        {
            errors = "Your rental must end after than its starts";
            return;
        }

        if (rental.RentalDateFrom < DateTime.Today || rental.RentalDateTo < DateTime.Today)
        {
            errors = "Your rental period must be later";
            return;
        }


        try
        {
            devices = await apiclient.GetDevicesForRentalAsync(deviceModel, priceForRent);
            errors = "";
        }
        catch (Exception ex)
        {
            logger.LogError($"{DateTime.Now} Error: {ex}");
            errors = "Error while connecting to the system";
        }
        StateHasChanged();
    }


    protected override async Task OnInitializedAsync()
    {

        try
        {
            //modelsNames = await apiclient.GetModelsAsync();
            //var allDevices = await apiclient.GetDevicesForRentalAsync(null, null);
            //modelsNames = allDevices.Select(d => d.Model).Distinct().OrderBy(m => m).ToList();
            

        }
        catch (ApiException ex)
        {
            if (modelsNames == null) modelsNames = new List<string>() { "All", };
            logger.LogError("Error! There was an error while connecting to the GetModelsAsync service");
        }

        //the type of RentalDateFrom is DateTimeOffset, it is required a conversion
        //https://learn.microsoft.com/es-es/dotnet/standard/datetime/converting-between-datetime-and-offset
        _from = (_from == new DateTime(1, 1, 1)) ?
            DateTime.SpecifyKind(DateTime.Today.AddDays(1), DateTimeKind.Utc)
            : _from;

        rental.RentalDateFrom = _from;

        //the type of RentalDateFrom is DateTimeOffset, it is required a conversion
        //https://learn.microsoft.com/es-es/dotnet/standard/datetime/converting-between-datetime-and-offset
        _to = (_to == new DateTime(1, 1, 1)) ?
            DateTime.SpecifyKind(DateTime.Today.AddDays(2), DateTimeKind.Utc)
            : _to;

        rental.RentalDateTo = _to;

        SearchDevices();

        //return base.OnInitializedAsync();
    }

    private void RentDevices()
    {
        navigation.NavigateTo("/rentals/createrental");
    }


}